# Mock backend server for testing (plain nginx - no Lua)

server {
    listen 8080;
    server_name _;

    # Root for static HTML files
    root /usr/share/nginx/html;

    # Health check endpoint
    location /health {
        access_log off;
        default_type application/json;
        return 200 '{"status":"healthy","service":"backend"}';
    }

    # Echo endpoint - shows received WAF headers
    location /echo {
        default_type application/json;
        return 200 '{"status":"ok","endpoint":"echo","waf_headers":{"form_hash":"$http_x_form_hash","spam_score":"$http_x_spam_score","spam_flags":"$http_x_spam_flags","client_ip":"$http_x_client_ip"}}';
    }

    # Form submission endpoint (POST only)
    location /submit {
        default_type application/json;
        return 200 '{"status":"success","message":"Form submitted successfully","waf_headers":{"form_hash":"$http_x_form_hash","spam_score":"$http_x_spam_score","spam_flags":"$http_x_spam_flags"}}';
    }

    # Contact form - GET serves HTML, POST returns JSON
    location /contact {
        if ($request_method = GET) {
            rewrite ^ /contact.html break;
        }
        default_type application/json;
        return 200 '{"status":"success","message":"Contact form received"}';
    }

    # Job application form - GET serves HTML, POST goes to /submit
    location /apply {
        if ($request_method = GET) {
            rewrite ^ /apply.html break;
        }
        default_type application/json;
        return 200 '{"status":"success","message":"Application received"}';
    }

    # Catch-all
    location / {
        default_type application/json;
        return 200 '{"status":"ok","endpoint":"$http_x_waf_endpoint","vhost":"$http_x_waf_vhost"}';
    }
}
