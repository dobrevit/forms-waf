{{- if and .Values.redis.enabled .Values.redisInit.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "forms-waf.fullname" . }}-redis-init
  labels:
    {{- include "forms-waf.labels" . | nindent 4 }}
    app.kubernetes.io/component: redis-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "forms-waf.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: redis-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: redis-init
          image: "{{ .Values.redisInit.image.repository }}:{{ .Values.redisInit.image.tag }}"
          imagePullPolicy: {{ .Values.redisInit.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              REDIS_HOST="{{ include "forms-waf.redis.host" . }}"
              REDIS_PORT="{{ include "forms-waf.redis.port" . }}"

              echo "Waiting for Redis to be ready..."
              until redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ping 2>/dev/null | grep -q PONG; do
                  echo "Waiting for Redis..."
                  sleep 2
              done

              echo "Loading blocked keywords..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:keywords:blocked \
              {{- range .Values.redisInit.blockedKeywords }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:keywords:blocked "placeholder-to-avoid-empty"

              echo "Loading flagged keywords..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:keywords:flagged \
              {{- range .Values.redisInit.flaggedKeywords }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:keywords:flagged "placeholder-to-avoid-empty"

              echo "Loading thresholds..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET waf:config:thresholds \
              {{- range $key, $value := .Values.redisInit.thresholds }}
                {{ $key }} {{ $value }} \
              {{- end }}
                placeholder 0
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HDEL waf:config:thresholds placeholder

              echo "Loading IP whitelist..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:whitelist:ips \
              {{- range .Values.redisInit.whitelistedIPs }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:whitelist:ips "placeholder-to-avoid-empty"

              {{- if .Values.adminUI.enabled }}
              echo "Creating default admin user..."
              ADMIN_SALT="waf_admin_salt_v1"
              ADMIN_PASSWORD="{{ .Values.adminUI.auth.defaultPassword }}"
              ADMIN_HASH=$(echo -n "${ADMIN_SALT}${ADMIN_PASSWORD}${ADMIN_SALT}" | sha256sum | cut -d' ' -f1)
              ADMIN_USER_JSON=$(cat <<EOF
              {
                "username": "{{ .Values.adminUI.auth.defaultUsername }}",
                "password_hash": "${ADMIN_HASH}",
                "salt": "${ADMIN_SALT}",
                "role": "admin",
                "vhost_scope": ["*"],
                "auth_provider": "local",
                "must_change_password": true,
                "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:admin:users:{{ .Values.adminUI.auth.defaultUsername }}" "$ADMIN_USER_JSON"
              echo "Created admin user: {{ .Values.adminUI.auth.defaultUsername }} (password: {{ .Values.adminUI.auth.defaultPassword }})"
              echo "WARNING: Change the default password on first login!"

              {{- if .Values.adminUI.auth.rbac.enabled }}
              echo "Creating RBAC role definitions..."
              # Admin role - full access
              ADMIN_ROLE_JSON=$(cat <<'ROLEEOF'
              {
                "id": "admin",
                "name": "Administrator",
                "description": "Full administrative access to all features",
                "permissions": {
                  "vhosts": ["create", "read", "update", "delete", "enable", "disable"],
                  "endpoints": ["create", "read", "update", "delete", "enable", "disable"],
                  "keywords": ["create", "read", "update", "delete"],
                  "config": ["read", "update"],
                  "users": ["create", "read", "update", "delete"],
                  "providers": ["create", "read", "update", "delete"],
                  "logs": ["read"],
                  "metrics": ["read", "reset"],
                  "bulk": ["import", "export", "clear"],
                  "captcha": ["create", "read", "update", "delete", "enable", "disable", "test"],
                  "webhooks": ["read", "update", "test"],
                  "geoip": ["read", "update", "reload"],
                  "reputation": ["read", "update"],
                  "timing": ["read", "update"],
                  "sync": ["execute"],
                  "status": ["read"],
                  "hashes": ["read", "create"],
                  "whitelist": ["read", "create"]
                },
                "scope": "global"
              }
              ROLEEOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:auth:roles:config:admin" "$ADMIN_ROLE_JSON"

              # Operator role - manage configurations but not users/providers
              OPERATOR_ROLE_JSON=$(cat <<'ROLEEOF'
              {
                "id": "operator",
                "name": "Operator",
                "description": "Manage WAF configurations within assigned vhosts",
                "permissions": {
                  "vhosts": ["read", "update", "enable", "disable"],
                  "endpoints": ["create", "read", "update", "delete", "enable", "disable"],
                  "keywords": ["create", "read", "update", "delete"],
                  "config": ["read"],
                  "logs": ["read"],
                  "metrics": ["read"],
                  "bulk": ["import", "export"],
                  "captcha": ["read"],
                  "webhooks": ["read"],
                  "geoip": ["read"],
                  "reputation": ["read"],
                  "timing": ["read"],
                  "status": ["read"],
                  "hashes": ["read", "create"],
                  "whitelist": ["read"]
                },
                "scope": "vhost-scoped"
              }
              ROLEEOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:auth:roles:config:operator" "$OPERATOR_ROLE_JSON"

              # Viewer role - read-only access
              VIEWER_ROLE_JSON=$(cat <<'ROLEEOF'
              {
                "id": "viewer",
                "name": "Viewer",
                "description": "Read-only access to WAF configurations",
                "permissions": {
                  "vhosts": ["read"],
                  "endpoints": ["read"],
                  "keywords": ["read"],
                  "config": ["read"],
                  "logs": ["read"],
                  "metrics": ["read"],
                  "captcha": ["read"],
                  "webhooks": ["read"],
                  "geoip": ["read"],
                  "reputation": ["read"],
                  "timing": ["read"],
                  "status": ["read"],
                  "hashes": ["read"],
                  "whitelist": ["read"]
                },
                "scope": "vhost-scoped"
              }
              ROLEEOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:auth:roles:config:viewer" "$VIEWER_ROLE_JSON"

              # Create role index
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD "waf:auth:roles:index" "admin" "operator" "viewer"

              echo "Created 3 RBAC roles: admin, operator, viewer"
              {{- end }}

              {{- if .Values.adminUI.auth.providers }}
              echo "Loading auth providers from Helm values..."
              {{- range $provider := .Values.adminUI.auth.providers }}
              {{- if $provider.enabled }}
              # Provider: {{ $provider.id }} ({{ $provider.type }})
              PROVIDER_{{ $provider.id | replace "-" "_" }}_JSON=$(cat <<'PROVIDEREOF'
              {{ $provider | toJson }}
              PROVIDEREOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:auth:providers:config:{{ $provider.id }}" "$PROVIDER_{{ $provider.id | replace "-" "_" }}_JSON"
              echo "  - Added provider: {{ $provider.id }} ({{ $provider.type }})"
              {{- end }}
              {{- end }}
              {{- end }}
              {{- end }}

              echo "Loading virtual hosts..."
              {{- range $vhost := .Values.redisInit.vhosts }}
              # Virtual host: {{ $vhost.id }}
              VHOST_{{ $vhost.id | replace "-" "_" }}='{{ $vhost.config | toJson }}'
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:vhosts:config:{{ $vhost.id }}" "$VHOST_{{ $vhost.id | replace "-" "_" }}"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZADD "waf:vhosts:index" {{ $vhost.priority | default 100 }} "{{ $vhost.id }}"
              {{- range $hostname := $vhost.hostnames }}
              {{- if hasPrefix "*" $hostname }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZADD "waf:vhosts:hosts:wildcard" {{ $vhost.priority | default 100 }} "{{ $hostname }}|{{ $vhost.id }}"
              {{- else }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET "waf:vhosts:hosts:exact" "{{ $hostname }}" "{{ $vhost.id }}"
              {{- end }}
              {{- end }}
              {{- end }}

              echo "Redis initialization complete!"
              echo "=== Loaded Data Summary ==="
              echo "Blocked keywords: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:keywords:blocked)"
              echo "Flagged keywords: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:keywords:flagged)"
              echo "Whitelisted IPs: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:whitelist:ips)"
              echo "Virtual hosts: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZCARD waf:vhosts:index)"
              {{- if .Values.adminUI.enabled }}
              echo "Admin users: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:admin:users:*' | wc -l)"
              {{- if .Values.adminUI.auth.rbac.enabled }}
              echo "RBAC roles: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:auth:roles:config:*' | wc -l)"
              {{- end }}
              {{- if .Values.adminUI.auth.providers }}
              echo "Auth providers: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:auth:providers:config:*' | wc -l)"
              {{- end }}
              echo ""
              echo "=== Admin UI Access ==="
              echo "Default credentials: {{ .Values.adminUI.auth.defaultUsername }} / {{ .Values.adminUI.auth.defaultPassword }}"
              echo "WARNING: Change password on first login!"
              {{- if .Values.adminUI.auth.providers }}
              echo ""
              echo "=== SSO Providers Configured ==="
              {{- range $provider := .Values.adminUI.auth.providers }}
              {{- if $provider.enabled }}
              echo "  - {{ $provider.name }} ({{ $provider.type }})"
              {{- end }}
              {{- end }}
              {{- end }}
              {{- end }}
{{- end }}
