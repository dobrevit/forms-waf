{{- if and .Values.redis.enabled .Values.redisInit.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "forms-waf.fullname" . }}-redis-init
  labels:
    {{- include "forms-waf.labels" . | nindent 4 }}
    app.kubernetes.io/component: redis-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "forms-waf.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: redis-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: redis-init
          image: "{{ .Values.redisInit.image.repository }}:{{ .Values.redisInit.image.tag }}"
          imagePullPolicy: {{ .Values.redisInit.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              REDIS_HOST="{{ include "forms-waf.redis.host" . }}"
              REDIS_PORT="{{ include "forms-waf.redis.port" . }}"

              echo "Waiting for Redis to be ready..."
              until redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ping 2>/dev/null | grep -q PONG; do
                  echo "Waiting for Redis..."
                  sleep 2
              done

              echo "Loading blocked keywords..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:keywords:blocked \
              {{- range .Values.redisInit.blockedKeywords }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:keywords:blocked "placeholder-to-avoid-empty"

              echo "Loading flagged keywords..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:keywords:flagged \
              {{- range .Values.redisInit.flaggedKeywords }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:keywords:flagged "placeholder-to-avoid-empty"

              echo "Loading thresholds..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET waf:config:thresholds \
              {{- range $key, $value := .Values.redisInit.thresholds }}
                {{ $key }} {{ $value }} \
              {{- end }}
                placeholder 0
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HDEL waf:config:thresholds placeholder

              {{- if .Values.redisInit.routing.enabled }}
              echo "Loading routing configuration..."
              {{- $haproxyFqdn := printf "%s-haproxy.%s.svc.cluster.local" (include "forms-waf.fullname" .) .Release.Namespace }}
              {{- $haproxyUpstream := .Values.openresty.env.HAPROXY_UPSTREAM | default "" }}
              {{- if not $haproxyUpstream }}
              {{- $haproxyUpstream = printf "%s:%d" $haproxyFqdn (int .Values.haproxy.service.port) }}
              {{- end }}
              {{- $haproxyUpstreamSsl := .Values.openresty.env.HAPROXY_UPSTREAM_SSL | default "" }}
              {{- if not $haproxyUpstreamSsl }}
              {{- $haproxyUpstreamSsl = printf "%s:%d" $haproxyFqdn (int .Values.haproxy.service.httpsPort) }}
              {{- end }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET waf:config:routing \
                haproxy_upstream "{{ $haproxyUpstream }}" \
                haproxy_upstream_ssl "{{ $haproxyUpstreamSsl }}" \
                upstream_ssl "{{ .Values.openresty.env.UPSTREAM_SSL | default "false" }}" \
                haproxy_timeout "{{ .Values.openresty.env.HAPROXY_TIMEOUT | default "30" }}"
              echo "  HAProxy upstream (HTTP): {{ $haproxyUpstream }}"
              echo "  HAProxy upstream (SSL):  {{ $haproxyUpstreamSsl }}"
              echo "  Use SSL: {{ .Values.openresty.env.UPSTREAM_SSL | default "false" }}"
              {{- end }}

              echo "Loading IP whitelist..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:whitelist:ips \
              {{- range .Values.redisInit.whitelistedIPs }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:whitelist:ips "placeholder-to-avoid-empty"

              {{- if .Values.adminUI.enabled }}
              # NOTE: Admin user and RBAC roles are now seeded by OpenResty/Lua on startup
              # See rbac.seed_default_admin() and rbac.seed_roles() in openresty/lua/rbac.lua
              # This ensures roles stay in sync with the codebase and allows secure salt generation
              echo "Admin user and RBAC roles will be seeded by OpenResty on startup (see rbac.lua)"
              {{- end }}

              {{- if .Values.adminUI.auth.providers }}
              echo "Loading auth providers from Helm values..."
              {{- range $provider := .Values.adminUI.auth.providers }}
              {{- if $provider.enabled }}
              # Provider: {{ $provider.id }} ({{ $provider.type }})
              PROVIDER_{{ $provider.id | replace "-" "_" }}_JSON=$(cat <<'PROVIDEREOF'
              {{ $provider | toJson }}
              PROVIDEREOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:auth:providers:config:{{ $provider.id }}" "$PROVIDER_{{ $provider.id | replace "-" "_" }}_JSON"
              echo "  - Added provider: {{ $provider.id }} ({{ $provider.type }})"
              {{- end }}
              {{- end }}
              {{- end }}

              echo "Loading virtual hosts..."
              {{- range $vhost := .Values.redisInit.vhosts }}
              # Virtual host: {{ $vhost.id }}
              VHOST_{{ $vhost.id | replace "-" "_" }}='{{ $vhost.config | toJson }}'
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:vhosts:config:{{ $vhost.id }}" "$VHOST_{{ $vhost.id | replace "-" "_" }}"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZADD "waf:vhosts:index" {{ $vhost.priority | default 100 }} "{{ $vhost.id }}"
              {{- range $hostname := $vhost.hostnames }}
              {{- if hasPrefix "*" $hostname }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZADD "waf:vhosts:hosts:wildcard" {{ $vhost.priority | default 100 }} "{{ $hostname }}|{{ $vhost.id }}"
              {{- else }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET "waf:vhosts:hosts:exact" "{{ $hostname }}" "{{ $vhost.id }}"
              {{- end }}
              {{- end }}
              {{- end }}

              echo "Redis initialization complete!"
              echo "=== Loaded Data Summary ==="
              echo "Blocked keywords: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:keywords:blocked)"
              echo "Flagged keywords: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:keywords:flagged)"
              echo "Whitelisted IPs: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:whitelist:ips)"
              echo "Virtual hosts: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZCARD waf:vhosts:index)"
              {{- if .Values.redisInit.routing.enabled }}
              echo ""
              echo "=== Routing Configuration ==="
              echo "HAProxy upstream (HTTP): $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HGET waf:config:routing haproxy_upstream)"
              echo "HAProxy upstream (SSL):  $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HGET waf:config:routing haproxy_upstream_ssl)"
              echo "Use SSL: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HGET waf:config:routing upstream_ssl)"
              echo "Timeout: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HGET waf:config:routing haproxy_timeout)s"
              {{- end }}
              {{- if .Values.adminUI.enabled }}
              echo "Admin users: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:admin:users:*' | wc -l)"
              {{- if .Values.adminUI.auth.rbac.enabled }}
              echo "RBAC roles: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:auth:roles:config:*' | wc -l)"
              {{- end }}
              {{- if .Values.adminUI.auth.providers }}
              echo "Auth providers: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:auth:providers:config:*' | wc -l)"
              {{- end }}
              echo ""
              echo "=== Admin UI Access ==="
              echo "Default credentials: {{ .Values.adminUI.auth.defaultUsername }} / {{ .Values.adminUI.auth.defaultPassword }}"
              echo "WARNING: Change password on first login!"
              {{- if .Values.adminUI.auth.providers }}
              echo ""
              echo "=== SSO Providers Configured ==="
              {{- range $provider := .Values.adminUI.auth.providers }}
              {{- if $provider.enabled }}
              echo "  - {{ $provider.name }} ({{ $provider.type }})"
              {{- end }}
              {{- end }}
              {{- end }}
              {{- end }}
{{- end }}
