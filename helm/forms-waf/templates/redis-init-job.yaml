{{- if and .Values.redis.enabled .Values.redisInit.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "forms-waf.fullname" . }}-redis-init
  labels:
    {{- include "forms-waf.labels" . | nindent 4 }}
    app.kubernetes.io/component: redis-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "forms-waf.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: redis-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: redis-init
          image: "{{ .Values.redisInit.image.repository }}:{{ .Values.redisInit.image.tag }}"
          imagePullPolicy: {{ .Values.redisInit.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              REDIS_HOST="{{ include "forms-waf.redis.host" . }}"
              REDIS_PORT="{{ include "forms-waf.redis.port" . }}"

              echo "Waiting for Redis to be ready..."
              until redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ping 2>/dev/null | grep -q PONG; do
                  echo "Waiting for Redis..."
                  sleep 2
              done

              echo "Loading blocked keywords..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:keywords:blocked \
              {{- range .Values.redisInit.blockedKeywords }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:keywords:blocked "placeholder-to-avoid-empty"

              echo "Loading flagged keywords..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:keywords:flagged \
              {{- range .Values.redisInit.flaggedKeywords }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:keywords:flagged "placeholder-to-avoid-empty"

              echo "Loading thresholds..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET waf:config:thresholds \
              {{- range $key, $value := .Values.redisInit.thresholds }}
                {{ $key }} {{ $value }} \
              {{- end }}
                placeholder 0
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HDEL waf:config:thresholds placeholder

              echo "Loading IP whitelist..."
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD waf:whitelist:ips \
              {{- range .Values.redisInit.whitelistedIPs }}
                "{{ . }}" \
              {{- end }}
                "placeholder-to-avoid-empty"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SREM waf:whitelist:ips "placeholder-to-avoid-empty"

              {{- if .Values.adminUI.enabled }}
              echo "Creating default admin user..."
              ADMIN_SALT="waf_admin_salt_v1"
              ADMIN_PASSWORD="{{ .Values.adminUI.auth.defaultPassword }}"
              ADMIN_HASH=$(echo -n "${ADMIN_SALT}${ADMIN_PASSWORD}${ADMIN_SALT}" | sha256sum | cut -d' ' -f1)
              ADMIN_USER_JSON=$(cat <<EOF
              {
                "username": "{{ .Values.adminUI.auth.defaultUsername }}",
                "password_hash": "${ADMIN_HASH}",
                "salt": "${ADMIN_SALT}",
                "role": "admin",
                "must_change_password": true,
                "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              )
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:admin:users:{{ .Values.adminUI.auth.defaultUsername }}" "$ADMIN_USER_JSON"
              echo "Created admin user: {{ .Values.adminUI.auth.defaultUsername }} (password: {{ .Values.adminUI.auth.defaultPassword }})"
              echo "WARNING: Change the default password on first login!"
              {{- end }}

              echo "Loading virtual hosts..."
              {{- range $vhost := .Values.redisInit.vhosts }}
              # Virtual host: {{ $vhost.id }}
              VHOST_{{ $vhost.id | replace "-" "_" }}='{{ $vhost.config | toJson }}'
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SET "waf:vhosts:config:{{ $vhost.id }}" "$VHOST_{{ $vhost.id | replace "-" "_" }}"
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SADD "waf:vhosts:index" "{{ $vhost.id }}"
              {{- range $hostname := $vhost.hostnames }}
              {{- if hasPrefix "*" $hostname }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" ZADD "waf:vhosts:hosts:wildcard" {{ $vhost.priority | default 100 }} "{{ $hostname }}|{{ $vhost.id }}"
              {{- else }}
              redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" HSET "waf:vhosts:hosts:exact" "{{ $hostname }}" "{{ $vhost.id }}"
              {{- end }}
              {{- end }}
              {{- end }}

              echo "Redis initialization complete!"
              echo "=== Loaded Data Summary ==="
              echo "Blocked keywords: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:keywords:blocked)"
              echo "Flagged keywords: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:keywords:flagged)"
              echo "Whitelisted IPs: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:whitelist:ips)"
              echo "Virtual hosts: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" SCARD waf:vhosts:index)"
              {{- if .Values.adminUI.enabled }}
              echo "Admin users: $(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" KEYS 'waf:admin:users:*' | wc -l)"
              echo ""
              echo "=== Admin UI Access ==="
              echo "Default credentials: {{ .Values.adminUI.auth.defaultUsername }} / {{ .Values.adminUI.auth.defaultPassword }}"
              echo "WARNING: Change password on first login!"
              {{- end }}
{{- end }}
