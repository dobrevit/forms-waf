Forms WAF has been deployed!

{{- if .Values.ingress.enabled }}
Access the WAF through the ingress:
{{- range $host := .Values.ingress.hosts }}
  http{{ if $.Values.ingress.tls }}s{{ end }}://{{ $host.host }}
{{- end }}
{{- else }}

To access the WAF locally, use port forwarding:

  # OpenResty (main entry point)
  kubectl port-forward svc/{{ include "forms-waf.fullname" . }}-openresty 8080:{{ .Values.openresty.service.port }}

  # HAProxy stats
  kubectl port-forward svc/{{ include "forms-waf.fullname" . }}-haproxy 8404:{{ .Values.haproxy.service.statsPort }}

{{- end }}

## Testing the WAF

1. Submit a legitimate form:
   curl -X POST http://localhost:8080/submit \
     -d "name=John&email=john@example.com&message=Hello"

2. Submit spam content (will be blocked):
   curl -X POST http://localhost:8080/submit \
     -d "name=Spammer&email=spam@test.com&message=Buy viagra now!"

3. Check HAProxy stats:
   Open http://localhost:8404/stats

{{- if .Values.adminUI.enabled }}
## Admin UI

Access the Admin UI (port 8082):

  kubectl port-forward svc/{{ include "forms-waf.fullname" . }}-openresty 8082:{{ .Values.openresty.service.adminPort }}

Then open: http://localhost:8082

Default credentials:
  Username: {{ .Values.adminUI.auth.defaultUsername }}
  Password: {{ .Values.adminUI.auth.defaultPassword }}

  ⚠️  IMPORTANT: Change the default password on first login!

{{- end }}
## Admin API

The WAF admin API is available at /api/ (requires authentication):

  # Login and get session
  curl -X POST http://localhost:8082/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username":"{{ .Values.adminUI.auth.defaultUsername }}","password":"{{ .Values.adminUI.auth.defaultPassword }}"}'

  # List blocked keywords (with session cookie)
  curl -b cookies.txt http://localhost:8082/api/keywords/blocked

  # Add a blocked keyword
  curl -b cookies.txt -X POST http://localhost:8082/api/keywords/blocked \
    -H "Content-Type: application/json" \
    -d '{"keyword":"newspam"}'

  # Check status
  curl -b cookies.txt http://localhost:8082/api/status

Legacy API (backward compatibility) is also available at /waf-admin/

## Redis Management

{{- if .Values.redis.enabled }}
Redis is deployed within the cluster. To access:

  kubectl exec -it $(kubectl get pods -l app.kubernetes.io/name=redis -o jsonpath='{.items[0].metadata.name}') -- redis-cli

{{- else }}
Redis is configured to use an external service at: {{ .Values.externalRedis.host }}:{{ .Values.externalRedis.port }}
{{- end }}

## Monitoring

{{- if .Values.monitoring.enabled }}
Prometheus metrics are available at:
  - OpenResty: http://localhost:8081/metrics
  - HAProxy: http://localhost:8404/metrics
{{- else }}
Monitoring is disabled. Enable it in values.yaml to expose Prometheus metrics.
{{- end }}

## Components

- OpenResty: {{ .Values.openresty.replicaCount }} replica(s) - Form parsing and filtering
- HAProxy: {{ .Values.haproxy.replicaCount }} replica(s) - Global rate limiting with stick-table sync
- Redis: Configuration store for keywords and rules
{{- if .Values.adminUI.enabled }}
- Admin UI: {{ .Values.adminUI.replicaCount }} replica(s) - Web-based administration interface
{{- end }}
