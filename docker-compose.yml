version: '3.8'

services:
  # Redis - Configuration store
  redis:
    image: redis:7-alpine
    container_name: waf-redis
    command: redis-server /usr/local/etc/redis/redis.conf
    user: root
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    ports:
      - "36379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - waf-network

  # Redis initialization
  redis-init:
    image: redis:7-alpine
    container_name: waf-redis-init
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./redis/init-data.sh:/init-data.sh:ro
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    entrypoint: ["/bin/sh", "/init-data.sh"]
    networks:
      - waf-network

  # OpenResty - Form processing and filtering
  openresty:
    build:
      context: ./openresty
      dockerfile: Dockerfile
    container_name: waf-openresty
    depends_on:
      redis:
        condition: service_healthy
      haproxy:
        condition: service_started
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - WAF_SYNC_INTERVAL=10
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8082:8082"  # Admin API - remove or restrict in production
    volumes:
      # Mount lua scripts for development (hot reload with nginx -s reload)
      - ./openresty/lua:/etc/nginx/lua:ro
      - ./openresty/conf/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro
      - ./maxmind:/usr/share/GeoIP:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - waf-network
    restart: on-failure

  # HAProxy - Global rate limiting and stick-tables
  haproxy:
    build:
      context: ./haproxy
      dockerfile: Dockerfile
    container_name: waf-haproxy
    environment:
      - BACKEND_HOST=backend
      - BACKEND_PORT=8080
      - KUBERNETES_MODE=false
    ports:
      - "8490:8080"
      - "8404:8404"
      - "8405:8405"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8405/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - waf-network
    restart: on-failure

  # Mock backend application
  backend:
    image: nginx:alpine
    container_name: waf-backend
    volumes:
      - ./scripts/backend-nginx.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - waf-network
    restart: on-failure

  # Admin UI - React-based administration interface
  admin-ui:
    build:
      context: ./admin-ui
      dockerfile: Dockerfile
    container_name: waf-admin-ui
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - waf-network
    restart: on-failure
    # No external ports - accessed via OpenResty proxy on port 8082

  # Redis Commander - Web UI for Redis (development only)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: waf-redis-commander
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8082:8081"
    profiles:
      - tools
    networks:
      - waf-network

volumes:
  redis-data:

networks:
  waf-network:
    driver: bridge
